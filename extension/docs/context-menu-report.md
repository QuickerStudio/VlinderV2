# 右键菜单技术报告

## 1. 概述

本文档详细介绍了 Mermaid 图表编辑器中右键菜单（`NodeContextMenu`）的技术实现、功能和最新更新。右键菜单是与图表节点和连接线进行交互的核心组件，提供了丰富的编辑功能。

## 2. 核心功能

右键菜单在不同的编辑模式下提供不同的功能：

### 2.1. 节点编辑模式 (`isEditMode`)

- **节点重命名**: 修改节点的显示文本。
- **节点ID更新**: 修改节点的唯一标识符。
- **注释管理**: 添加或更新节点的注释。
- **节点操作**: 添加、删除节点。
- **样式应用**: 为节点应用预设的样式。
- **节点类型更改**: 将节点从一种类型（如矩形）更改为另一种类型（如菱形）。

### 2.2. 连接线编辑模式 (`isEdgeEditMode`)

- **连接线列表**: 显示从所选节点出发的所有连接线。
- **连接线删除**: 单独删除某条连接线。
- **连接线样式更改**: 修改连接线的样式（例如，`-->` 变为 `-.->`）。

## 3. 技术实现

### 3.1. 组件结构

- **`NodeContextMenu.tsx`**: 右键菜单的主组件，负责UI渲染和事件处理。
- **`use-edge-manager.ts`**: 核心的 Hook，负责连接线的解析、索引和操作。
- **`book-panel.tsx`**: 主面板组件，负责状态管理和将 `use-edge-manager` 的功能传递给 `NodeContextMenu`。

### 3.2. 连接线解析与识别

连接线的识别是右键菜单的核心功能之一。我们通过正则表达式来解析 Mermaid 代码，并提取出连接线的源节点、目标节点和样式。

最新的正则表达式支持以下节点格式：

- **简单节点**: `A`, `B`, `C`
- **复杂节点**: `A[开始]`, `B{判断条件}`, `C(处理)`

```javascript
const nodePattern = "\\w+(?:\\[[^\\]]*\\]|\\{[^}]*\\}|\\([^)]*\\))?";
const captureNodePattern = `(${nodePattern})`;
const labeledRegex = new RegExp(`^${captureNodePattern}\\s*(-->|-.->|==>|-\\.\\.->)\\s*\\|([^|]+)\\|\\s*${captureNode-Pattern}`);
const normalRegex = new RegExp(`^${captureNodePattern}\\s*(-->|-.->|==>|-\\.\\.->|---|===|-\\.-)\\s*${captureNode-Pattern}`);
```

### 3.3. 状态管理

- **`selectedEdgeId`**: 通过 `useState` 来跟踪当前选中的连接线，以便显示连接线样式的修改选项。
- **`isOpen`**: 控制菜单的显示和隐藏。
- **`x`, `y`**: 控制菜单的显示位置。

## 4. 最近更新

- **支持复杂节点格式**: 增强了正则表达式，使其能够正确解析和处理 `A[开始] --> B{判断条件}` 这样的复杂节点定义。
- **修复连接线样式**: 修正了带标签连接线的格式，并确保所有13种连接线样式都能被正确识别和修改。
- **代码重构**: 优化了 `use-edge-manager.ts` 中的代码结构，提高了代码的可读性和可维护性。

## 5. 未来展望

- **多选支持**: 支持同时选择和操作多个节点或连接线。
- **自定义样式**: 允许用户自定义节点的颜色、边框等样式。
- **撤销/重做**: 添加对操作的撤销和重做支持。

