name: ðŸš€ ä¸€é”®å‘å¸ƒ

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      bump_type:
        description: 'é€‰æ‹©ç‰ˆæœ¬æ›´æ–°ç±»åž‹'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch   # Bug ä¿®å¤: 3.7.21 -> 3.7.22
          - minor   # æ–°åŠŸèƒ½: 3.7.21 -> 3.8.0
          - major   # é‡å¤§æ›´æ–°: 3.7.21 -> 4.0.0

jobs:
  auto-release:
    name: è‡ªåŠ¨å‘å¸ƒ Vlinder
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: ðŸ”¢ è‡ªåŠ¨è®¡ç®—æ–°ç‰ˆæœ¬å·
        id: version
        run: |
          echo "ðŸ“Š å½“å‰ç‰ˆæœ¬ä¿¡æ¯ï¼š"
          CURRENT=$(node -p "require('./extension/package.json').version")
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT"
          
          # è‡ªåŠ¨è®¡ç®—æ–°ç‰ˆæœ¬å·
          cd extension
          npm version ${{ github.event.inputs.bump_type }} --no-git-tag-version
          NEW=$(node -p "require('./package.json').version")
          cd ..
          
          echo "æ–°ç‰ˆæœ¬: $NEW"
          echo "VERSION=$NEW" >> $GITHUB_OUTPUT
          echo "CURRENT=$CURRENT" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… ç‰ˆæœ¬å·å·²è‡ªåŠ¨æ›´æ–°: $CURRENT â†’ $NEW"

      - name: ðŸ“ ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          echo "ðŸ“‹ æ”¶é›†æäº¤ä¿¡æ¯..."
          
          # èŽ·å–æœ€åŽä¸€ä¸ªæ ‡ç­¾
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            echo "è¿™æ˜¯ç¬¬ä¸€ä¸ªå‘å¸ƒç‰ˆæœ¬"
            COMMITS=$(git log --pretty=format:"- %s" --no-merges | head -20)
          else
            echo "ä¸Šä¸€ä¸ªç‰ˆæœ¬: $LAST_TAG"
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          fi
          
          # ç”Ÿæˆ Release Notes
          cat > release_notes.md << EOF
          ## ðŸ¦‹ Vlinder v${{ steps.version.outputs.VERSION }}
          
          ### ðŸ“Š ç‰ˆæœ¬ä¿¡æ¯
          - **æ›´æ–°ç±»åž‹**: ${{ github.event.inputs.bump_type }}
          - **ç‰ˆæœ¬å˜åŒ–**: ${{ steps.version.outputs.CURRENT }} â†’ ${{ steps.version.outputs.VERSION }}
          - **å‘å¸ƒæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          ### ðŸ“ æ›´æ–°å†…å®¹
          
          $COMMITS
          
          ### ðŸ“¦ å®‰è£…æ–¹å¼
          
          **æ–¹å¼ 1: VS Code æ’ä»¶å¸‚åœºï¼ˆæŽ¨èï¼‰**
          1. æ‰“å¼€ VS Code
          2. æŒ‰ \`Ctrl+Shift+X\` æ‰“å¼€æ‰©å±•é¢æ¿
          3. æœç´¢ "Vlinder"
          4. ç‚¹å‡»å®‰è£…
          
          **æ–¹å¼ 2: ä¸‹è½½ VSIX æ–‡ä»¶**
          1. ä¸‹è½½ä¸‹æ–¹çš„ \`.vsix\` æ–‡ä»¶
          2. åœ¨ VS Code ä¸­æŒ‰ \`Ctrl+Shift+P\`
          3. è¾“å…¥ "Install from VSIX"
          4. é€‰æ‹©ä¸‹è½½çš„æ–‡ä»¶
          
          ### ðŸ”— å¿«é€Ÿé“¾æŽ¥
          
          - ðŸ›’ [VS Code Marketplace](https://marketplace.visualstudio.com/items?itemName=QuickerStudio.vlinder)
          - ðŸŒ [Open VSX Registry](https://open-vsx.org/extension/QuickerStudio/vlinder)
          - ðŸ“š [å®Œæ•´æ–‡æ¡£](https://github.com/QuickerStudio/Vlinder/blob/main/README.md)
          - ðŸ“‹ [æ›´æ–°æ—¥å¿—](https://github.com/QuickerStudio/Vlinder/blob/main/CHANGELOG.md)
          - ðŸŒ [å®˜æ–¹ç½‘ç«™](https://vlinders.org)
          
          ### ðŸ’ æ„Ÿè°¢
          
          æ„Ÿè°¢æ‰€æœ‰ä½¿ç”¨ Vlinder çš„æœ‹å‹ä»¬ï¼ä½ ä»¬çš„æ”¯æŒæ˜¯æˆ‘ä»¬å‰è¿›çš„åŠ¨åŠ›ã€‚
          
          å¦‚æžœä½ å–œæ¬¢ Vlinderï¼Œè¯·ç»™æˆ‘ä»¬ä¸€ä¸ª â­ Starï¼
          
          ---
          
          **ðŸ¦‹ è®© Vlinder å±žäºŽä¸–ç•Œï¼Œå±žäºŽä½ æˆ‘ï¼**
          EOF
          
          echo "âœ… Release Notes å·²ç”Ÿæˆ"

      - name: ðŸ’¾ æäº¤ç‰ˆæœ¬æ›´æ–°
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add extension/package.json
          git commit -m "chore: ðŸ”– bump version to ${{ steps.version.outputs.VERSION }} [skip ci]"
          echo "âœ… ç‰ˆæœ¬æ›´æ–°å·²æäº¤"

      - name: ðŸ·ï¸ åˆ›å»º Git æ ‡ç­¾
        run: |
          git tag "v${{ steps.version.outputs.VERSION }}"
          echo "âœ… æ ‡ç­¾ v${{ steps.version.outputs.VERSION }} å·²åˆ›å»º"

      - name: â¬†ï¸ æŽ¨é€åˆ° GitHub
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
          tags: true

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        working-directory: ./extension
        run: |
          echo "ðŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
          pnpm run install:all
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ðŸ”¨ æž„å»º Webview
        working-directory: ./extension
        run: |
          echo "ðŸ”¨ æž„å»º Webview..."
          pnpm run build:webview
          echo "âœ… Webview æž„å»ºå®Œæˆ"

      - name: ðŸ“¦ æ‰“åŒ…æ‰©å±•
        working-directory: ./extension
        run: |
          echo "ðŸ“¦ æ‰“åŒ…æ‰©å±•..."
          pnpm run build
          echo "âœ… æ‰©å±•æ‰“åŒ…å®Œæˆ"

      - name: ðŸ“‹ èŽ·å–åŒ…æ–‡ä»¶ä¿¡æ¯
        id: package
        run: |
          PACKAGE_FILE=$(ls extension/*.vsix | head -n 1)
          PACKAGE_SIZE=$(du -h "$PACKAGE_FILE" | cut -f1)
          echo "PACKAGE_FILE=$PACKAGE_FILE" >> $GITHUB_OUTPUT
          echo "PACKAGE_SIZE=$PACKAGE_SIZE" >> $GITHUB_OUTPUT
          echo "âœ… åŒ…æ–‡ä»¶: $PACKAGE_FILE (å¤§å°: $PACKAGE_SIZE)"

      - name: ðŸŽ‰ åˆ›å»º GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          release_name: ðŸ¦‹ Vlinder v${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false

      - name: â¬†ï¸ ä¸Šä¼  VSIX æ–‡ä»¶
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.package.outputs.PACKAGE_FILE }}
          asset_name: vlinder-${{ steps.version.outputs.VERSION }}.vsix
          asset_content_type: application/octet-stream

      - name: ðŸ›’ å‘å¸ƒåˆ° VS Code Marketplace
        working-directory: ./extension
        env:
          VSCE_PAT: ${{ secrets.VSCE_TOKEN }}
        run: |
          echo "ðŸ›’ å‘å¸ƒåˆ° VS Code Marketplace..."
          pnpm vsce publish --packagePath ../${{ steps.package.outputs.PACKAGE_FILE }} --pat $VSCE_PAT
          echo "âœ… VS Code Marketplace å‘å¸ƒæˆåŠŸ"

      - name: ðŸŒ å‘å¸ƒåˆ° Open VSX Registry
        working-directory: ./extension
        env:
          OVSX_PAT: ${{ secrets.OVSX_TOKEN }}
        run: |
          echo "ðŸŒ å‘å¸ƒåˆ° Open VSX Registry..."
          npx ovsx publish ../${{ steps.package.outputs.PACKAGE_FILE }} --pat $OVSX_PAT
          echo "âœ… Open VSX Registry å‘å¸ƒæˆåŠŸ"

      - name: ðŸ“Š ç”Ÿæˆå‘å¸ƒæ‘˜è¦
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸŽ‰ å‘å¸ƒæˆåŠŸï¼
          
          ## ðŸ“Š ç‰ˆæœ¬ä¿¡æ¯
          
          | é¡¹ç›® | ä¿¡æ¯ |
          |------|------|
          | ðŸ”– ç‰ˆæœ¬å· | **v${{ steps.version.outputs.VERSION }}** |
          | ðŸ“ˆ æ›´æ–°ç±»åž‹ | **${{ github.event.inputs.bump_type }}** |
          | ðŸ“¦ åŒ…å¤§å° | **${{ steps.package.outputs.PACKAGE_SIZE }}** |
          | â° å‘å¸ƒæ—¶é—´ | **$(date '+%Y-%m-%d %H:%M:%S UTC')** |
          
          ## ðŸ”— å‘å¸ƒé“¾æŽ¥
          
          - ðŸ“¦ [GitHub Release](https://github.com/QuickerStudio/Vlinder/releases/tag/v${{ steps.version.outputs.VERSION }})
          - ðŸ›’ [VS Code Marketplace](https://marketplace.visualstudio.com/items?itemName=QuickerStudio.vlinder)
          - ðŸŒ [Open VSX Registry](https://open-vsx.org/extension/QuickerStudio/vlinder)
          - ðŸŒ [å®˜æ–¹ç½‘ç«™](https://vlinders.org)
          
          ## âœ… ä¸‹ä¸€æ­¥
          
          1. âœ… åœ¨ VS Code Marketplace éªŒè¯æ–°ç‰ˆæœ¬
          2. âœ… åœ¨ Open VSX Registry éªŒè¯æ–°ç‰ˆæœ¬
          3. âœ… æµ‹è¯•ä»Žå¸‚åœºå®‰è£…æ–°ç‰ˆæœ¬
          4. âœ… å‘ç”¨æˆ·å®£å¸ƒæ–°ç‰ˆæœ¬å‘å¸ƒ
          5. âœ… æ›´æ–°ç›¸å…³æ–‡æ¡£ï¼ˆå¦‚éœ€è¦ï¼‰
          
          ## ðŸŽŠ æ­å–œï¼
          
          **Vlinder v${{ steps.version.outputs.VERSION }} å·²æˆåŠŸå‘å¸ƒåˆ°æ‰€æœ‰å¹³å°ï¼** ðŸ¦‹
          
          ---
          
          *è‡ªåŠ¨ç”ŸæˆäºŽ $(date '+%Y-%m-%d %H:%M:%S UTC')*
          EOF

      - name: âŒ å‘å¸ƒå¤±è´¥å¤„ç†
        if: failure()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # âŒ å‘å¸ƒå¤±è´¥
          
          ## é”™è¯¯ä¿¡æ¯
          
          - **ç›®æ ‡ç‰ˆæœ¬**: v${{ steps.version.outputs.VERSION }}
          - **æ›´æ–°ç±»åž‹**: ${{ github.event.inputs.bump_type }}
          - **å¤±è´¥æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          ## ðŸ” æ•…éšœæŽ’æŸ¥
          
          ### å¸¸è§é—®é¢˜
          
          1. **Token è¿‡æœŸ**
             - æ£€æŸ¥ `VSCE_TOKEN` æ˜¯å¦è¿‡æœŸ
             - æ£€æŸ¥ `OVSX_TOKEN` æ˜¯å¦è¿‡æœŸ
             - é‡æ–°ç”Ÿæˆ token å¹¶æ›´æ–° GitHub Secrets
          
          2. **ç‰ˆæœ¬å†²çª**
             - ç‰ˆæœ¬å·å¯èƒ½å·²å­˜åœ¨äºŽå¸‚åœº
             - æ£€æŸ¥æ˜¯å¦å·²å‘å¸ƒç›¸åŒç‰ˆæœ¬
          
          3. **æž„å»ºå¤±è´¥**
             - æ£€æŸ¥æž„å»ºæ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
             - éªŒè¯ä¾èµ–æ˜¯å¦æ­£ç¡®å®‰è£…
          
          4. **ç½‘ç»œé—®é¢˜**
             - æ£€æŸ¥ä¸Ž VS Code Marketplace çš„è¿žæŽ¥
             - æ£€æŸ¥ä¸Ž Open VSX çš„è¿žæŽ¥
          
          ## ðŸ“ è§£å†³æ­¥éª¤
          
          1. æŸ¥çœ‹ä¸Šæ–¹çš„è¯¦ç»†æ—¥å¿—
          2. æ ¹æ®é”™è¯¯ä¿¡æ¯ä¿®å¤é—®é¢˜
          3. é‡æ–°è¿è¡Œå·¥ä½œæµ
          
          ## ðŸ“ž èŽ·å–å¸®åŠ©
          
          - æŸ¥çœ‹ [å‘å¸ƒæŒ‡å—](.github/docs/RELEASE_GUIDE.md)
          - æŸ¥çœ‹ [æ•…éšœæŽ’é™¤](.github/docs/QUICK_START_CN.md)
          - æäº¤ [Issue](https://github.com/QuickerStudio/Vlinder/issues)
          
          ---
          
          *è¯·ä¿®å¤é—®é¢˜åŽé‡è¯•*
          EOF

