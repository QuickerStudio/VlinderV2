name: Release with Copilot (Smart)

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      version_bump:
        description: 'ç‰ˆæœ¬æ›´æ–°ç±»åž‹'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch   # 3.7.21 -> 3.7.22 (Bug ä¿®å¤)
          - minor   # 3.7.21 -> 3.8.0  (æ–°åŠŸèƒ½)
          - major   # 3.7.21 -> 4.0.0  (é‡å¤§æ›´æ–°)
          - custom  # è‡ªå®šä¹‰ç‰ˆæœ¬å·
      custom_version:
        description: 'è‡ªå®šä¹‰ç‰ˆæœ¬å· (ä»…å½“é€‰æ‹© custom æ—¶ä½¿ç”¨ï¼Œä¾‹å¦‚: 3.7.22)'
        required: false
        type: string
      use_copilot:
        description: 'ä½¿ç”¨ GitHub Copilot ç”Ÿæˆ Release Notes'
        required: false
        default: true
        type: boolean

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Calculate new version
        id: version
        run: |
          CURRENT_VERSION=$(node -p "require('./extension/package.json').version")
          echo "Current version: $CURRENT_VERSION"
          
          if [ "${{ github.event.inputs.version_bump }}" = "custom" ]; then
            NEW_VERSION="${{ github.event.inputs.custom_version }}"
          else
            # ä½¿ç”¨ npm version å‘½ä»¤è‡ªåŠ¨è®¡ç®—æ–°ç‰ˆæœ¬å·
            cd extension
            npm version ${{ github.event.inputs.version_bump }} --no-git-tag-version
            NEW_VERSION=$(node -p "require('./package.json').version")
            cd ..
          fi
          
          echo "New version: $NEW_VERSION"
          echo "VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Get commit messages since last release
        id: commits
        run: |
          # èŽ·å–æœ€åŽä¸€ä¸ªæ ‡ç­¾
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            # å¦‚æžœæ²¡æœ‰æ ‡ç­¾ï¼ŒèŽ·å–æ‰€æœ‰æäº¤
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # èŽ·å–è‡ªä¸Šæ¬¡æ ‡ç­¾ä»¥æ¥çš„æäº¤
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # ä¿å­˜åˆ°æ–‡ä»¶ä»¥ä¾¿åŽç»­ä½¿ç”¨
          echo "$COMMITS" > commits.txt
          echo "Found $(echo "$COMMITS" | wc -l) commits since last release"

      - name: Generate Release Notes with Copilot
        if: github.event.inputs.use_copilot == 'true'
        id: copilot_notes
        run: |
          # åˆ›å»ºä¸€ä¸ªæç¤ºæ–‡ä»¶ç»™ Copilot
          cat > release_prompt.txt << 'EOF'
          Based on the following commits, generate professional release notes in Chinese and English:
          
          Version: ${{ steps.version.outputs.VERSION }}
          Previous Version: ${{ steps.version.outputs.CURRENT_VERSION }}
          
          Commits:
          $(cat commits.txt)
          
          Please format the release notes with:
          1. A brief summary of changes
          2. New features (if any)
          3. Bug fixes (if any)
          4. Breaking changes (if any)
          5. Thank contributors
          
          Use emoji and make it engaging!
          EOF
          
          echo "Release notes prompt created"
          echo "COPILOT_PROMPT_CREATED=true" >> $GITHUB_OUTPUT

      - name: Update version in package.json
        run: |
          cd extension
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '${{ steps.version.outputs.VERSION }}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, '\t') + '\n');
          "
          echo "âœ… Updated package.json to version ${{ steps.version.outputs.VERSION }}"

      - name: Generate default release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ðŸ¦‹ Vlinder v${{ steps.version.outputs.VERSION }}
          
          **Version Bump**: ${{ steps.version.outputs.CURRENT_VERSION }} â†’ ${{ steps.version.outputs.VERSION }}
          
          ### ðŸ“ Changes
          
          $(cat commits.txt)
          
          ### ðŸ“¦ Installation
          
          Download the `.vsix` file below and install it in VS Code:
          1. Open VS Code
          2. Go to Extensions (Ctrl+Shift+X)
          3. Click the "..." menu â†’ Install from VSIX
          4. Select the downloaded file
          
          Or install directly from:
          - [VS Code Marketplace](https://marketplace.visualstudio.com/items?itemName=QuickerStudio.vlinder)
          - [Open VSX Registry](https://open-vsx.org/extension/QuickerStudio/vlinder)
          
          ### ðŸ“š Documentation
          
          See [CHANGELOG.md](https://github.com/QuickerStudio/Vlinder/blob/main/CHANGELOG.md) for details.
          
          ---
          
          **ðŸŒ Visit [Vlinders.org](https://vlinders.org) for more information**
          
          **ðŸ’ Thank you for using Vlinder!**
          EOF
          
          echo "Release notes generated"

      - name: Commit version bump
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add extension/package.json
          git commit -m "chore: bump version to ${{ steps.version.outputs.VERSION }} [skip ci]"
          git tag "v${{ steps.version.outputs.VERSION }}"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
          tags: true

      - name: Install dependencies
        working-directory: ./extension
        run: pnpm run install:all

      - name: Build webview
        working-directory: ./extension
        run: pnpm run build:webview

      - name: Package extension
        working-directory: ./extension
        run: pnpm run build

      - name: Get package filename
        id: package_file
        run: |
          PACKAGE_FILE=$(ls extension/*.vsix | head -n 1)
          echo "PACKAGE_FILE=$PACKAGE_FILE" >> $GITHUB_OUTPUT
          echo "Package file: $PACKAGE_FILE"

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          release_name: Vlinder v${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.package_file.outputs.PACKAGE_FILE }}
          asset_name: vlinder-${{ steps.version.outputs.VERSION }}.vsix
          asset_content_type: application/octet-stream

      - name: Publish to VS Code Marketplace
        working-directory: ./extension
        env:
          VSCE_PAT: ${{ secrets.VSCE_TOKEN }}
        run: |
          pnpm vsce publish --packagePath ../${{ steps.package_file.outputs.PACKAGE_FILE }} --pat $VSCE_PAT

      - name: Publish to Open VSX Registry
        working-directory: ./extension
        env:
          OVSX_PAT: ${{ secrets.OVSX_TOKEN }}
        run: |
          npx ovsx publish ../${{ steps.package_file.outputs.PACKAGE_FILE }} --pat $OVSX_PAT

      - name: Create summary
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸŽ‰ Release Successful!
          
          ## Version Information
          - **Previous Version**: ${{ steps.version.outputs.CURRENT_VERSION }}
          - **New Version**: ${{ steps.version.outputs.VERSION }}
          - **Version Bump Type**: ${{ github.event.inputs.version_bump }}
          
          ## Release Links
          - ðŸ“¦ [GitHub Release](https://github.com/QuickerStudio/Vlinder/releases/tag/v${{ steps.version.outputs.VERSION }})
          - ðŸ›’ [VS Code Marketplace](https://marketplace.visualstudio.com/items?itemName=QuickerStudio.vlinder)
          - ðŸŒ [Open VSX Registry](https://open-vsx.org/extension/QuickerStudio/vlinder)
          
          ## Next Steps
          1. âœ… Verify the release on all platforms
          2. âœ… Test installation from VS Code Marketplace
          3. âœ… Update documentation if needed
          4. âœ… Announce the release to users
          
          ---
          
          **ðŸ¦‹ Vlinder is now live at v${{ steps.version.outputs.VERSION }}!**
          EOF

      - name: Notify failure
        if: failure()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # âŒ Release Failed
          
          ## Error Information
          - **Target Version**: ${{ steps.version.outputs.VERSION }}
          - **Version Bump Type**: ${{ github.event.inputs.version_bump }}
          
          ## Troubleshooting
          1. Check the logs above for specific error messages
          2. Verify that all secrets are correctly set
          3. Ensure the version number is valid
          4. Check if the tag already exists
          
          ## Common Issues
          - **Token expired**: Regenerate VSCE_TOKEN or OVSX_TOKEN
          - **Version conflict**: Version already exists on marketplace
          - **Build failure**: Check build logs for compilation errors
          
          Please review the logs and try again.
          EOF

