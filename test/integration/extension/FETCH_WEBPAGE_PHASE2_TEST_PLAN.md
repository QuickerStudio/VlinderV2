# Fetch-Webpage Tool - Phase 2: 测试计划

**日期**: 2025-10-07  
**目标**: 为fetch-webpage工具的未测试高级功能设计全面的测试计划

---

## 📋 测试分类

### Category A: 缓存机制测试 (6个测试)

#### A1: 基本缓存功能 - 第二次从缓存读取
- **目标**: 验证LRU缓存基本功能
- **步骤**:
  1. 第一次获取URL，记录耗时
  2. 第二次获取相同URL，记录耗时
  3. 验证第二次从缓存读取（耗时显著减少）
  4. 验证内容相同
- **期望**: 缓存命中，速度提升10x以上

#### A2: 缓存统计正确
- **目标**: 验证缓存统计功能
- **步骤**:
  1. 清除缓存
  2. 获取URL1（miss）
  3. 再次获取URL1（hit）
  4. 获取URL2（miss）
  5. 检查统计：hits=1, misses=2, size=2
- **期望**: 统计数据准确

#### A3: 缓存清除功能
- **目标**: 验证缓存清除
- **步骤**:
  1. 获取URL，验证缓存size=1
  2. 清除缓存
  3. 验证缓存size=0
  4. 再次获取URL，验证是miss
- **期望**: 清除后缓存为空

#### A4: 不同URL独立缓存
- **目标**: 验证不同URL独立缓存
- **步骤**:
  1. 获取URL1和URL2
  2. 验证缓存size=2
  3. 验证两个URL内容不同
- **期望**: 每个URL独立缓存

#### A5: 相同URL不同query共享缓存
- **目标**: 验证相同URL的不同query共享底层缓存
- **步骤**:
  1. 获取URL（无query）
  2. 获取相同URL（有query）
  3. 验证第二次是缓存命中
  4. 验证返回内容不同（因为query过滤）
- **期望**: 共享缓存，但过滤结果不同

#### A6: 错误响应不缓存
- **目标**: 验证错误响应不被缓存
- **步骤**:
  1. 获取不存在的URL（404）
  2. 验证缓存size=0
  3. 再次获取，验证仍是miss
- **期望**: 错误不缓存

---

### Category B: TF-IDF算法测试 (3个测试)

#### B1: 基本查询过滤
- **目标**: 验证TF-IDF基本过滤功能
- **步骤**:
  1. 获取网页，提供query
  2. 验证返回内容包含query相关片段
  3. 验证XML包含`<relevant_sections>`
- **期望**: 返回相关内容片段

#### B2: 精确短语匹配加分
- **目标**: 验证精确短语匹配获得2x加分
- **步骤**:
  1. 获取网页，query包含多个词
  2. 验证返回内容包含完整短语的片段排在前面
- **期望**: 精确匹配优先

#### B3: 限制返回块数量
- **目标**: 验证最多返回10个内容块
- **步骤**:
  1. 获取网页，使用常见query（如"的"）
  2. 统计返回的section数量
  3. 验证<=10个
- **期望**: 最多10个块

---

### Category C: 真实网络场景测试 (3个测试)

#### C1: 百度百科页面
- **目标**: 验证真实中文网站获取
- **步骤**:
  1. 获取百度百科JavaScript页面
  2. 验证成功获取
  3. 验证内容包含"JavaScript"
  4. 验证XML格式正确
- **期望**: 成功获取真实网页

#### C2: 多URL并行获取
- **目标**: 验证并行获取多个URL
- **步骤**:
  1. 同时获取2个真实URL
  2. 记录总耗时
  3. 验证两个都成功
  4. 验证XML包含2个page
- **期望**: 并行处理，耗时接近单个URL

#### C3: 部分失败场景
- **目标**: 验证部分URL失败不影响整体
- **步骤**:
  1. 获取1个真实URL + 1个不存在URL
  2. 验证status=success（部分成功）
  3. 验证successful=1, failed=1
  4. 验证包含成功内容和错误信息
- **期望**: 部分成功，不影响整体

---

### Category D: 高级安全特性测试 (3个测试)

#### D1: 阻止AWS元数据服务
- **目标**: 验证阻止169.254.169.254
- **步骤**:
  1. 尝试获取http://169.254.169.254
  2. 验证status=error
  3. 验证错误信息包含"SSRF"或"blocked"
- **期望**: 请求被阻止

#### D2: 阻止Google元数据服务
- **目标**: 验证阻止metadata.google.internal
- **步骤**:
  1. 尝试获取http://metadata.google.internal
  2. 验证status=error
  3. 验证错误信息包含"SSRF"或"blocked"
- **期望**: 请求被阻止

#### D3: 阻止file://协议
- **目标**: 验证仅允许HTTP/HTTPS
- **步骤**:
  1. 尝试获取file:///etc/passwd
  2. 验证status=error
  3. 验证错误信息包含"protocol"或"blocked"
- **期望**: 请求被阻止

---

## 🎯 测试策略

### 真实集成测试
- **原则**: 调用真实代码，最小化Mock
- **Mock范围**: 仅Mock VS Code API
- **网络请求**: 使用真实中文网站（百度百科、菜鸟教程）
- **数据验证**: 验证真实HTML解析、Markdown转换、TF-IDF算法

### 测试数据源
- **真实网站**: 
  - https://baike.baidu.com/item/JavaScript
  - https://www.runoob.com/js/js-intro.html
- **本地文件**: 
  - Pattern-Search-test-file/fetch-webpage-tfidf-doc*.txt
  - Pattern-Search-test-file/fetch-webpage-large.html

### 性能基准
- **单URL获取**: <5秒
- **缓存命中**: <100ms
- **并行2个URL**: <10秒
- **安全检查**: <10ms

---

## 📊 成功标准

### 功能性
- ✅ 所有15个测试通过
- ✅ 缓存机制正常工作
- ✅ TF-IDF算法正确过滤
- ✅ 真实网站成功获取
- ✅ 安全防护有效

### 性能
- ✅ 缓存命中速度提升10x以上
- ✅ 并行获取效率高
- ✅ 安全检查开销小

### 质量
- ✅ 代码覆盖率100%
- ✅ 错误处理完善
- ✅ 日志信息清晰
- ✅ XML输出格式正确

---

## 🔧 实施计划

### Phase 3: 测试数据准备
1. 创建TF-IDF测试文档
2. 创建大文件测试数据
3. 验证真实网站可访问性

### Phase 4: 测试实现
1. 创建测试文件: `fetch-webpage-advanced-integration.test.ts`
2. 实现15个测试用例
3. 配置Mock和Helper函数

### Phase 5: 测试执行
1. 运行测试套件
2. 分析失败原因
3. 记录性能指标

### Phase 6: 迭代改进
1. 修复发现的问题
2. 优化测试断言
3. 确保100%通过率

### Phase 7: 质量报告
1. 生成测试报告
2. 评估工具质量
3. 提供改进建议

---

**计划创建时间**: 2025-10-07  
**预计完成时间**: 2025-10-07  
**测试方法**: 严格遵循 tester.prompt.ts 的7阶段测试流程

