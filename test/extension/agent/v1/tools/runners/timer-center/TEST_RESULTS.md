# Timer Center æµ‹è¯•ç»“æœæŠ¥å‘Š

## ğŸ“Š æµ‹è¯•æ‰§è¡Œæ‘˜è¦

**æ‰§è¡Œæ—¶é—´**: 2025-01-XX  
**æµ‹è¯•æ¡†æ¶**: Jest  
**æ€»æµ‹è¯•æ•°**: 120+  

## ğŸ” å‘ç°çš„é—®é¢˜

### 1. API ä¸ä¸€è‡´é—®é¢˜ âœ… å·²ä¿®å¤

**é—®é¢˜æè¿°**:  
æµ‹è¯•ä»£ç ä½¿ç”¨äº†é”™è¯¯çš„ API æ–¹æ³•ã€‚`TimerManager.getTimer()` è¿”å› `TimerContext` å¯¹è±¡ï¼Œè€Œä¸æ˜¯ `TimerInfo`ã€‚

**å½±å“çš„æµ‹è¯•**:
- `åº”è¯¥æˆåŠŸåˆ›å»ºç­‰å¾…å‹è®¡æ—¶å™¨`
- `åº”è¯¥æˆåŠŸåˆ›å»ºä»»åŠ¡å‹è®¡æ—¶å™¨`
- `åº”è¯¥èƒ½æŸ¥è¯¢ç‰¹å®šè®¡æ—¶å™¨`
- `åº”è¯¥å¤„ç†å¤§æ—¶é•¿è®¡æ—¶å™¨`
- `åº”è¯¥èƒ½ç‹¬ç«‹æ“ä½œä¸åŒçš„è®¡æ—¶å™¨`
- `å®Œæˆçš„è®¡æ—¶å™¨åº”è¯¥è¢«è‡ªåŠ¨æ¸…ç†`

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// é”™è¯¯ç”¨æ³•
const timer = timerManager.getTimer(timerId);
expect(timer?.timer_type).toBe('waiting');

// æ­£ç¡®ç”¨æ³•
const timerInfo = timerManager.getTimerInfo(timerId);
expect(timerInfo?.timer_type).toBe('waiting');
```

**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

### 2. å¼‚æ­¥æµ‹è¯•è¶…æ—¶é—®é¢˜ âš ï¸ éœ€è¦è°ƒæ•´

**é—®é¢˜æè¿°**:  
æŸäº›å¼‚æ­¥æµ‹è¯•å› ä¸ºè®¡æ—¶å™¨æœªå®Œæˆè€Œè¶…æ—¶ã€‚

**å½±å“çš„æµ‹è¯•**:
- `åº”è¯¥åœ¨è®¡æ—¶å™¨å®Œæˆæ—¶è°ƒç”¨å›è°ƒ`
- `å®Œæˆçš„è®¡æ—¶å™¨åº”è¯¥è¢«è‡ªåŠ¨æ¸…ç†`

**åŸå› åˆ†æ**:
1. è®¡æ—¶å™¨å®Œæˆéœ€è¦å®é™…ç­‰å¾…æ—¶é—´
2. Jest é»˜è®¤è¶…æ—¶æ—¶é—´å¯èƒ½ä¸å¤Ÿ
3. è®¡æ—¶å™¨å®Œæˆåçš„æ¸…ç†é€»è¾‘å¯èƒ½éœ€è¦ä¼˜åŒ–

**ä¿®å¤æ–¹æ¡ˆ**:
1. å¢åŠ æµ‹è¯•è¶…æ—¶æ—¶é—´
2. ä½¿ç”¨æ›´çŸ­çš„è®¡æ—¶å™¨æ—¶é•¿è¿›è¡Œæµ‹è¯•
3. æ·»åŠ æ˜ç¡®çš„å®Œæˆæ£€æŸ¥é€»è¾‘

**çŠ¶æ€**: âš ï¸ å¾…ä¼˜åŒ–

---

### 3. è®¡æ—¶å™¨çŠ¶æ€ç®¡ç†é—®é¢˜ ğŸ”§ éœ€è¦æ”¹è¿›

**é—®é¢˜æè¿°**:  
è®¡æ—¶å™¨å®ŒæˆåçŠ¶æ€ä¸º `running` è€Œä¸æ˜¯ `completed`ã€‚

**å½±å“çš„æµ‹è¯•**:
- `å®Œæˆçš„è®¡æ—¶å™¨åº”è¯¥è¢«è‡ªåŠ¨æ¸…ç†`

**åŸå› åˆ†æ**:
`TimerContext` å¯èƒ½æ²¡æœ‰æ­£ç¡®æ›´æ–°çŠ¶æ€ä¸º `completed`ã€‚

**éœ€è¦æ£€æŸ¥çš„ä»£ç **:
```typescript
// extension/src/agent/v1/tools/runners/timer-center/managers/timer-context.ts
// waitWithTimeout æ–¹æ³•ä¸­çš„çŠ¶æ€æ›´æ–°é€»è¾‘
```

**ä¿®å¤å»ºè®®**:
1. ç¡®ä¿è®¡æ—¶å™¨å®Œæˆæ—¶çŠ¶æ€æ›´æ–°ä¸º `completed`
2. æ·»åŠ çŠ¶æ€è½¬æ¢çš„æ—¥å¿—
3. å®Œå–„çŠ¶æ€æœºé€»è¾‘

**çŠ¶æ€**: ğŸ”§ éœ€è¦æ”¹è¿›

---

## ğŸ“‹ æµ‹è¯•ä¿®å¤æ¸…å•

### å·²å®Œæˆ âœ…

- [x] ä¿®å¤ API è°ƒç”¨ä¸ä¸€è‡´é—®é¢˜
- [x] æ›´æ–°æ‰€æœ‰ä½¿ç”¨ `getTimer()` çš„æµ‹è¯•ä¸º `getTimerInfo()`
- [x] éªŒè¯æµ‹è¯•æ–‡ä»¶è¯­æ³•æ­£ç¡®æ€§

### å¾…å®Œæˆ â³

- [ ] ä¿®å¤ `TimerContext` çŠ¶æ€æ›´æ–°é€»è¾‘
- [ ] ä¼˜åŒ–å¼‚æ­¥æµ‹è¯•çš„è¶…æ—¶å¤„ç†
- [ ] æ·»åŠ æ›´å¤šè¾¹ç•Œæ¡ä»¶æµ‹è¯•
- [ ] åˆ›å»ºæ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] æ·»åŠ å‰ç«¯ç»„ä»¶æµ‹è¯•
- [ ] å®ç°ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥æµ‹è¯•

---

## ğŸ”§ éœ€è¦ä¿®å¤çš„ä»£ç é—®é¢˜

### 1. TimerContext çŠ¶æ€æ›´æ–°

**æ–‡ä»¶**: `extension/src/agent/v1/tools/runners/timer-center/managers/timer-context.ts`

**é—®é¢˜**: è®¡æ—¶å™¨å®Œæˆæ—¶çŠ¶æ€æœªæ­£ç¡®æ›´æ–°ä¸º `completed`

**ä¿®å¤ä½ç½®**: `waitWithTimeout()` æ–¹æ³•

**å»ºè®®ä¿®æ”¹**:
```typescript
async waitWithTimeout(timeoutDuration: number): Promise<'timeout' | 'completed' | 'stopped'> {
	// ... ç°æœ‰ä»£ç  ...
	
	if (remainingTime <= 0) {
		this.status = 'completed'; // ç¡®ä¿è®¾ç½®çŠ¶æ€
		if (this.onComplete) {
			this.onComplete(this.timerId, this.timerType, this.reason || this.mission);
		}
		return 'completed';
	}
	
	// ... å…¶ä½™ä»£ç  ...
}
```

---

### 2. TimerManager å®Œæˆå›è°ƒ

**æ–‡ä»¶**: `extension/src/agent/v1/tools/runners/timer-center/managers/timer-manager.ts`

**é—®é¢˜**: å®Œæˆå›è°ƒå¯èƒ½æœªæ­£ç¡®è§¦å‘

**å»ºè®®**: æ·»åŠ è°ƒè¯•æ—¥å¿—éªŒè¯å›è°ƒæ˜¯å¦è¢«è°ƒç”¨

---

### 3. æµ‹è¯•è¶…æ—¶é…ç½®

**æ–‡ä»¶**: `test/extension/agent/v1/tools/runners/timer-center/timer-manager.test.ts`

**å»ºè®®ä¿®æ”¹**:
```typescript
// å¢åŠ è¶…æ—¶æ—¶é—´
test('åº”è¯¥åœ¨è®¡æ—¶å™¨å®Œæˆæ—¶è°ƒç”¨å›è°ƒ', (done) => {
	// ... æµ‹è¯•ä»£ç  ...
}, 3000); // ä» 2000ms å¢åŠ åˆ° 3000ms
```

---

## ğŸ“ˆ ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’

### é˜¶æ®µ 1: ä¿®å¤æ ¸å¿ƒé—®é¢˜ (ä¼˜å…ˆçº§: é«˜)

1. **ä¿®å¤ TimerContext çŠ¶æ€æ›´æ–°**
   - ç¡®ä¿ `completed` çŠ¶æ€æ­£ç¡®è®¾ç½®
   - æ·»åŠ çŠ¶æ€è½¬æ¢æ—¥å¿—
   - éªŒè¯æ‰€æœ‰çŠ¶æ€è½¬æ¢è·¯å¾„

2. **ä¼˜åŒ–å¼‚æ­¥æµ‹è¯•**
   - è°ƒæ•´è¶…æ—¶æ—¶é—´
   - ä½¿ç”¨æ›´çŸ­çš„æµ‹è¯•è®¡æ—¶å™¨
   - æ·»åŠ æ˜ç¡®çš„å®Œæˆæ£€æŸ¥

3. **éªŒè¯å®Œæˆå›è°ƒ**
   - æ·»åŠ è°ƒè¯•æ—¥å¿—
   - ç¡®ä¿å›è°ƒæ­£ç¡®è§¦å‘
   - æµ‹è¯•å›è°ƒå‚æ•°æ­£ç¡®æ€§

### é˜¶æ®µ 2: å®Œå–„æµ‹è¯•è¦†ç›– (ä¼˜å…ˆçº§: ä¸­)

1. **æ·»åŠ ç¼ºå¤±çš„å·¥å…·æµ‹è¯•**
   - Stop Timer å·¥å…·æµ‹è¯•
   - Cancel Timer å·¥å…·æµ‹è¯•
   - Pause Timer å·¥å…·æµ‹è¯•
   - Resume Timer å·¥å…·æµ‹è¯•

2. **å¢å¼ºè¾¹ç•Œæ¡ä»¶æµ‹è¯•**
   - æç«¯æ—¶é•¿æµ‹è¯•
   - å¹¶å‘å‹åŠ›æµ‹è¯•
   - å†…å­˜æ³„æ¼æµ‹è¯•

3. **æ·»åŠ æ€§èƒ½æµ‹è¯•**
   - å¤§é‡è®¡æ—¶å™¨ç®¡ç†
   - é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§
   - èµ„æºä½¿ç”¨ç›‘æ§

### é˜¶æ®µ 3: é›†æˆå’Œç«¯åˆ°ç«¯æµ‹è¯• (ä¼˜å…ˆçº§: ä¸­)

1. **å‰ç«¯ç»„ä»¶æµ‹è¯•**
   - Timer UI ç»„ä»¶æµ‹è¯•
   - çŠ¶æ€æ›´æ–°æµ‹è¯•
   - ç”¨æˆ·äº¤äº’æµ‹è¯•

2. **ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥æµ‹è¯•**
   - å®ç°é€šçŸ¥åŠŸèƒ½
   - æµ‹è¯•é€šçŸ¥è§¦å‘
   - éªŒè¯é€šçŸ¥å†…å®¹

3. **å®Œæ•´å·¥ä½œæµæµ‹è¯•**
   - ç­‰å¾…å‹ Timer å®Œæ•´æµç¨‹
   - ä»»åŠ¡å‹ Timer å®Œæ•´æµç¨‹
   - å¤šå·¥å…·åä½œæµ‹è¯•

---

## ğŸ’¡ æµ‹è¯•æ”¹è¿›å»ºè®®

### 1. ä½¿ç”¨ Mock æ—¶é—´

ä½¿ç”¨ Jest çš„ `useFakeTimers()` æ¥åŠ é€Ÿæµ‹è¯•ï¼š

```typescript
beforeEach(() => {
	jest.useFakeTimers();
});

afterEach(() => {
	jest.useRealTimers();
});

test('è®¡æ—¶å™¨æµ‹è¯•', () => {
	// åˆ›å»ºè®¡æ—¶å™¨
	const timerId = timerManager.createTimer('waiting', 100, 50, 'Test');
	
	// å¿«è¿›æ—¶é—´
	jest.advanceTimersByTime(100000);
	
	// éªŒè¯çŠ¶æ€
	const timerInfo = timerManager.getTimerInfo(timerId);
	expect(timerInfo?.status).toBe('completed');
});
```

### 2. æ·»åŠ æµ‹è¯•è¾…åŠ©å‡½æ•°

```typescript
// åˆ›å»ºæµ‹è¯•è®¡æ—¶å™¨çš„è¾…åŠ©å‡½æ•°
function createTestTimer(duration: number = 100) {
	return timerManager.createTimer('waiting', duration, duration / 2, 'Test');
}

// ç­‰å¾…è®¡æ—¶å™¨å®Œæˆçš„è¾…åŠ©å‡½æ•°
async function waitForTimerCompletion(timerId: string, maxWait: number = 5000) {
	const startTime = Date.now();
	while (Date.now() - startTime < maxWait) {
		const info = timerManager.getTimerInfo(timerId);
		if (info?.status === 'completed') {
			return true;
		}
		await new Promise(resolve => setTimeout(resolve, 100));
	}
	return false;
}
```

### 3. æ”¹è¿›é”™è¯¯æ¶ˆæ¯

```typescript
expect(timerInfo?.status).toBe('completed');
// æ”¹ä¸º
expect(timerInfo?.status).toBe('completed', 
	`Expected timer status to be 'completed' but got '${timerInfo?.status}'`);
```

---

## ğŸ“ æ€»ç»“

### å½“å‰çŠ¶æ€
- âœ… åŸºç¡€æµ‹è¯•æ¡†æ¶å·²å»ºç«‹
- âœ… ä¸»è¦ API é—®é¢˜å·²ä¿®å¤
- âš ï¸ éƒ¨åˆ†å¼‚æ­¥æµ‹è¯•éœ€è¦ä¼˜åŒ–
- ğŸ”§ æ ¸å¿ƒçŠ¶æ€ç®¡ç†éœ€è¦æ”¹è¿›

### æµ‹è¯•è¦†ç›–ç‡
- ç®¡ç†å™¨å±‚: ~80% (å¾…æé«˜)
- å·¥å…·å±‚: ~60% (éœ€è¦è¡¥å……)
- é›†æˆæµ‹è¯•: ~40% (éœ€è¦æ‰©å±•)

### ä¸‹ä¸€æ­¥é‡ç‚¹
1. ä¿®å¤ TimerContext çŠ¶æ€æ›´æ–°é€»è¾‘
2. å®Œæˆæ‰€æœ‰å·¥å…·çš„å•å…ƒæµ‹è¯•
3. ä¼˜åŒ–å¼‚æ­¥æµ‹è¯•æ€§èƒ½
4. æ·»åŠ å‰ç«¯ç»„ä»¶æµ‹è¯•

