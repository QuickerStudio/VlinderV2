# Multi-Replace-String Tool - Phase 1: Requirements Analysis

**测试日期**: 2025-10-07  
**测试目标**: extension/src/agent/v1/tools/schema/multi-replace-string.ts  
**测试方法**: 真实集成测试（Real Integration Testing）

---

## 1. 工具核心功能

### 1.1 主要功能
- **批量字符串替换**: 在多个文件中执行多个替换操作
- **原子性操作**: 使用 WorkspaceEdit 确保所有替换要么全部成功，要么全部失败
- **文件分组**: 按文件分组替换操作，提高效率
- **顺序控制**: 支持通过 `order` 参数控制替换执行顺序

### 1.2 高级特性
1. **大小写不敏感匹配** (`caseInsensitive: true`)
   - 匹配时忽略大小写
   - 例如: "hello" 可以匹配 "Hello", "HELLO", "HeLLo"

2. **正则表达式模式** (`useRegex: true`)
   - 支持正则表达式搜索
   - 支持捕获组 ($1, $2, $3...)
   - 例如: `user_(\d+)` → `customer_$1`

3. **执行顺序控制** (`order: number`)
   - 低数字先执行
   - 支持链式替换（A→B→C）
   - 默认 order = 0

4. **特殊字符处理**
   - XML实体: &lt; &gt; &amp; &quot; &apos;
   - 数字实体（十进制）: &#10; (换行), &#9; (制表符), &#13; (回车)
   - 数字实体（十六进制）: &#xA; (换行), &#x9; (制表符), &#xD; (回车)
   - 双反斜杠: \\ → \
   - Windows路径: 直接使用，不需要转义

### 1.3 输入验证
- 替换数组不能为空
- filePath 必须是非空字符串
- oldString 必须是非空字符串（不能替换空字符串）
- newString 可以为空（删除文本）

---

## 2. 现有测试覆盖分析

### 2.1 已覆盖的测试（26个测试）

#### 输入验证 (7个)
- ✅ 空替换数组
- ✅ XML字符串格式解析
- ✅ null替换数组
- ✅ 无效filePath
- ✅ 空filePath
- ✅ 无效oldString
- ✅ 无效newString

#### 用户审批流程 (3个)
- ✅ 请求用户审批
- ✅ 用户拒绝审批
- ✅ 审批后更新状态

#### 单文件替换 (3个)
- ✅ 单次替换
- ✅ 多次相同替换
- ✅ 多个不同替换

#### 多文件替换 (2个)
- ✅ 跨文件相同替换
- ✅ 不同文件不同替换

#### 错误处理 (5个)
- ✅ 文件不存在
- ✅ 字符串未找到
- ✅ 混合成功/失败
- ✅ 文件读取错误
- ✅ WorkspaceEdit失败

#### 边缘情况 (6个)
- ✅ 空newString（删除文本）
- ✅ 拒绝空oldString
- ✅ 特殊字符
- ✅ Unicode字符
- ✅ 超长字符串
- ✅ 多次相同替换

### 2.2 缺失的测试覆盖

#### 🔴 高级特性测试（核心功能）
1. **大小写不敏感匹配** - ❌ 未测试
   - 基本大小写不敏感
   - 与正则表达式结合
   - 边缘情况（全大写、全小写、混合）

2. **正则表达式模式** - ❌ 未测试
   - 基本正则表达式
   - 捕获组替换 ($1, $2...)
   - 复杂正则模式
   - 无效正则表达式
   - 正则特殊字符转义

3. **执行顺序控制** - ❌ 未测试
   - 基本顺序控制
   - 链式替换（A→B→C）
   - 相同order的处理
   - 负数order
   - 跨文件顺序

4. **特殊字符处理** - ⚠️ 部分测试
   - ❌ XML数字实体（&#10;, &#9;, &#13;）
   - ❌ 十六进制实体（&#xA;, &#x9;, &#xD;）
   - ❌ 换行符替换
   - ❌ 制表符替换
   - ❌ Windows路径处理
   - ✅ 基本特殊字符（已测试）

#### 🟡 性能和实际场景
5. **大文件处理** - ❌ 未测试
   - 大文件（>1MB）
   - 大量匹配（>1000个）
   - 批处理性能

6. **实际使用场景** - ❌ 未测试
   - 重构场景（函数重命名）
   - 配置更新场景
   - 批量修复场景
   - 跨文件依赖更新

#### 🟢 边缘情况增强
7. **更多边缘情况** - ⚠️ 部分测试
   - ❌ 重叠替换
   - ❌ 循环替换（A→B, B→A）
   - ❌ 文件路径规范化
   - ❌ 相对路径 vs 绝对路径
   - ❌ 大小写敏感的文件系统

---

## 3. 成功标准

### 3.1 功能完整性
- ✅ 所有核心功能正常工作
- ✅ 所有高级特性正常工作
- ✅ 所有边缘情况正确处理

### 3.2 测试覆盖率
- 目标: **100%功能覆盖**
- 当前: ~40%（26个测试，主要覆盖基础功能）
- 需要: 额外 **30-40个测试** 覆盖高级特性

### 3.3 质量指标
- **通过率**: 100%
- **性能**: 所有测试 <5秒
- **可靠性**: 无间歇性失败
- **可维护性**: 测试代码清晰、易读

---

## 4. 预期行为文档

### 4.1 大小写不敏感匹配
```typescript
// 输入
{
  filePath: "test.txt",
  oldString: "hello",
  newString: "hi",
  caseInsensitive: true
}

// 文件内容: "Hello WORLD, hello world"
// 预期结果: "hi WORLD, hi world"
// 说明: 匹配 "Hello" 和 "hello"，但保留原始大小写的上下文
```

### 4.2 正则表达式捕获组
```typescript
// 输入
{
  filePath: "test.txt",
  oldString: "user_(\\d+)",
  newString: "customer_$1",
  useRegex: true
}

// 文件内容: "user_123 and user_456"
// 预期结果: "customer_123 and customer_456"
// 说明: $1 引用第一个捕获组 (\d+)
```

### 4.3 执行顺序控制
```typescript
// 输入
[
  { filePath: "test.txt", oldString: "A", newString: "B", order: 1 },
  { filePath: "test.txt", oldString: "B", newString: "C", order: 2 }
]

// 文件内容: "A B C"
// 预期结果: "C C C"
// 说明: 
//   - order=1: "A B C" → "B B C" (A→B)
//   - order=2: "B B C" → "C C C" (B→C)
```

### 4.4 XML数字实体
```typescript
// 输入
{
  filePath: "test.txt",
  oldString: "line1&#10;line2",  // &#10; = 换行符
  newString: "single line"
}

// 文件内容: "line1\nline2"
// 预期结果: "single line"
// 说明: &#10; 被解析为 \n
```

### 4.5 Windows路径处理
```typescript
// 输入
{
  filePath: "test.txt",
  oldString: "C:\\Users\\Test\\file.txt",
  newString: "D:\\Data\\file.txt"
}

// 文件内容: "Path: C:\Users\Test\file.txt"
// 预期结果: "Path: D:\Data\file.txt"
// 说明: 反斜杠不需要额外转义
```

---

## 5. 测试数据需求

### 5.1 测试文件
- **基础文本文件**: 简单文本，用于基本替换测试
- **代码文件**: JavaScript/TypeScript，用于重构场景
- **配置文件**: JSON/YAML，用于配置更新场景
- **特殊字符文件**: 包含换行、制表符、Unicode
- **大文件**: >1MB，用于性能测试

### 5.2 测试数据库
- 使用 `Pattern-Search-test-file` 数据库
- 需要创建额外的测试文件用于特定场景

---

## 6. 风险和挑战

### 6.1 技术风险
1. **正则表达式复杂性**: 需要处理各种正则模式和边缘情况
2. **顺序替换逻辑**: 链式替换可能导致意外结果
3. **特殊字符处理**: XML实体和转义序列的正确处理
4. **性能问题**: 大文件和大量替换的性能

### 6.2 测试挑战
1. **Mock vs Real**: 需要真实文件系统测试，但VS Code API需要mock
2. **原子性验证**: 如何验证WorkspaceEdit的原子性
3. **顺序验证**: 如何验证替换按正确顺序执行

---

## 7. 下一步行动

### Phase 2: Test Planning
1. 创建详细的测试用例列表（30-40个新测试）
2. 分类测试：高级特性、性能、边缘情况
3. 设计测试数据结构
4. 规划测试文件组织

**预计新增测试数量**: 35个
**预计总测试数量**: 61个（26现有 + 35新增）
**预计测试覆盖率**: 95%+

