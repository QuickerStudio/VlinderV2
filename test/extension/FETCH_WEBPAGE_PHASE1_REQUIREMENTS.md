# Fetch-Webpage Tool - Phase 1: Requirements Analysis

**测试日期**: 2025-10-07  
**测试目标**: extension/src/agent/v1/tools/runners/fetch-webpage.tool.ts  
**测试方法**: 真实集成测试（Real Integration Testing）

---

## 1. 工具核心功能

### 1.1 主要功能
- **网页获取**: 使用Node.js fetch API获取网页内容
- **多URL支持**: 一次最多获取10个URL，并行处理
- **HTML转Markdown**: 使用turndown库将HTML转换为Markdown
- **内容过滤**: 基于查询关键词过滤和排序内容
- **智能缓存**: LRU缓存机制，5分钟TTL

### 1.2 高级特性
1. **安全验证** (SSRF防护)
   - 只允许HTTP/HTTPS协议
   - 阻止私有IP地址访问
   - 阻止内部元数据服务访问

2. **内容提取**
   - 移除script、style、iframe等无关标签
   - 优先提取main/article/content区域
   - 清理多余空白字符

3. **查询过滤** (TF-IDF算法)
   - 基于查询词创建内容块
   - 计算相关性分数
   - 返回最相关的前10个块

4. **错误处理**
   - 超时控制（30秒）
   - 网络错误识别（DNS、连接拒绝、超时）
   - HTTP状态码处理
   - 部分失败隔离

5. **性能优化**
   - 并行获取多个URL
   - LRU缓存（最多100个条目）
   - 内容长度限制（50KB）
   - 批量处理

### 1.3 输入参数
- **urls**: 字符串数组，1-10个URL（必需）
- **query**: 可选的搜索查询字符串

### 1.4 输出格式
XML格式，包含：
- 总URL数、成功数、失败数
- 成功的页面内容（全文或相关片段）
- 失败的错误信息

---

## 2. 现有测试覆盖分析

### 2.1 现有测试文件

发现4个测试文件：
1. **fetch-webpage.tool.test.ts** (785行) - ✅ 40个测试全部通过
2. **fetch-webpage.comprehensive.test.ts** (357行) - ❌ Mock问题，无法运行
3. **fetch-webpage.integration.test.ts** (262行) - ❌ Mock问题，无法运行
4. **fetch-webpage.manual-test.ts** (204行) - 手动测试

### 2.2 已测试的功能（40个测试）

#### A. 参数验证 (10个测试)
- ✅ 单个URL
- ✅ 多个URL
- ✅ 拒绝超过10个URL
- ✅ 拒绝无效URL
- ✅ 拒绝非HTTP/HTTPS协议
- ✅ 拒绝私有IP (127.0.0.1, 192.168.x.x, 10.x.x.x, localhost)

#### B. 内容获取 (5个测试)
- ✅ 成功获取HTML内容
- ✅ 处理纯文本内容
- ✅ 拒绝不支持的内容类型
- ✅ 处理HTTP错误状态
- ✅ 处理网络错误
- ✅ 处理超时

#### C. HTML处理 (3个测试)
- ✅ HTML转Markdown
- ✅ 移除script和style标签
- ✅ 提取main/article内容

#### D. 查询过滤 (3个测试)
- ✅ 根据查询过滤内容
- ✅ 包含查询匹配的上下文
- ✅ 按相关性评分排序内容块

#### E. 多URL处理 (3个测试)
- ✅ 并行获取多个URL
- ✅ 处理部分成功的情况
- ✅ 所有URL失败时返回错误

#### F. 内容截断 (2个测试)
- ✅ 截断过长的内容
- ✅ 限制返回的内容块数量

#### G. XML输出格式 (4个测试)
- ✅ 正确的XML结构
- ✅ 转义XML特殊字符
- ✅ 包含查询信息
- ✅ 包含错误信息

#### H. 边界情况 (5个测试)
- ✅ 处理空HTML
- ✅ 处理格式错误的HTML
- ✅ 处理Unicode内容
- ✅ 处理空查询
- ✅ 处理不匹配的查询

#### I. 日志记录 (4个测试)
- ✅ 记录获取开始
- ✅ 记录成功完成
- ✅ 记录内容截断警告
- ✅ 记录错误

#### J. 集成测试 (1个测试)
- ✅ 完整的成功流程 - 多URL带查询

### 2.3 未测试的高级功能

#### 1. 缓存机制 ❌
- LRU缓存逻辑
- 缓存命中/未命中
- 缓存过期（TTL）
- 缓存统计
- 缓存大小限制（100条目）
- ETag和Last-Modified支持

#### 2. TF-IDF算法 ❌
- TF（词频）计算
- IDF（逆文档频率）计算
- 精确短语匹配加分
- 位置加分（早期内容优先）
- 重叠块去除

#### 3. 安全特性 ❌
- 阻止元数据服务（metadata.google.internal, 169.254.169.254）
- IPv6私有地址（::1, fe80:, fc00:, fd00:）
- 重定向限制（最多5次）

#### 4. 真实网络场景 ❌
- 真实网页获取（GitHub, MDN, npm等）
- 真实HTML解析
- 真实Markdown转换
- 真实查询过滤

#### 5. 性能测试 ❌
- 大页面处理（接近50KB限制）
- 多URL并行性能
- 缓存性能提升
- 超时边界测试

#### 6. 错误恢复 ❌
- DNS解析失败（ENOTFOUND）
- 连接拒绝（ECONNREFUSED）
- 连接超时（ETIMEDOUT）
- 重定向循环

---

## 3. 测试策略

### 3.1 测试目标
围绕工具的核心价值不断优化改进，直到满足开发需求。

### 3.2 核心价值
1. **可靠性**: 稳定获取网页内容，正确处理各种错误
2. **安全性**: 防止SSRF攻击，保护内网安全
3. **性能**: 快速并行获取，智能缓存
4. **智能性**: TF-IDF算法精准过滤相关内容
5. **易用性**: 清晰的XML输出，有用的错误信息

### 3.3 测试重点
基于未测试功能，重点测试：
1. **缓存机制** - 核心性能优化
2. **TF-IDF算法** - 核心智能特性
3. **真实网络场景** - 实际使用验证
4. **高级安全特性** - 完整安全保护
5. **性能边界** - 极限情况处理

### 3.4 测试方法
- **真实集成测试**: 调用实际代码，使用真实数据
- **最小化Mock**: 只Mock VS Code API，不Mock网络请求
- **真实网页**: 使用真实的公开网页（GitHub, MDN等）
- **性能测量**: 记录执行时间，验证缓存效果

---

## 4. 成功标准

### 4.1 功能完整性
- ✅ 所有核心功能正常工作
- ✅ 所有高级特性经过测试
- ✅ 所有边缘情况得到处理

### 4.2 质量指标
- 测试通过率: 100%
- 代码覆盖率: >90%
- 性能: 单URL <5秒，缓存命中<100ms
- 错误处理: 所有错误都有清晰的消息

### 4.3 实际使用验证
- ✅ 能够获取真实的GitHub README
- ✅ 能够获取真实的MDN文档
- ✅ 能够获取真实的npm包信息
- ✅ 查询过滤返回相关内容
- ✅ 缓存显著提升性能

---

## 5. 下一步：Phase 2 - Test Planning

需要设计测试用例覆盖：
1. 缓存机制（8-10个测试）
2. TF-IDF算法（6-8个测试）
3. 真实网络场景（5-7个测试）
4. 高级安全特性（4-5个测试）
5. 性能测试（3-4个测试）
6. 错误恢复（4-5个测试）

**预计新增测试**: 30-40个
**预计总测试数**: 70-80个

